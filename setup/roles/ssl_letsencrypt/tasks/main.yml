---

- name: GA | Cert LetsEncrypt | Install package
  ansible.builtin.apt:
    name: ['python3', 'python3-certbot-apache', 'software-properties-common']
    state: present

- name: GA | Cert LetsEncrypt | Check if a apache virtualhost is available
  ansible.builtin.shell: 'ls -l /etc/apache2/sites-enabled/'
  register: enabled_apache_sites

- name: GA | Cert LetsEncrypt | Configuring dependencies
  ansible.builtin.include_tasks: dependencies.yml
  when:
    - '"total 0" in enabled_apache_sites["stdout_lines"]'
    - enabled_apache_sites["stdout_lines"] | length == 1

- name: GA | Cert LetsEncrypt | Configuring certbot
  ansible.builtin.include_tasks: domain.yml

- name: GA | Cert LetsEncrypt | Cleanup dependencies
  ansible.builtin.include_tasks: cleanup.yml

- name: GA | Cert LetsEncrypt | Adding systemd files for certbot renewal
  ansible.builtin.template:
    src: "templates/lib/systemd/system/{{ item }}"
    dest: "/lib/systemd/system/{{ item }}"
  with_items:
    - 'ga_web_certRenewal.service'
    - 'ga_web_certRenewal.timer'

- name: GA | Cert LetsEncrypt | Reloading systemd
  ansible.builtin.systemd:
    daemon_reload: yes

- name: GA | Cert LetsEncrypt | Enabling service
  ansible.builtin.systemd:
    name: 'ga_web_certRenewal.timer'
    enabled: yes
    state: started

- name: GA | Cert LetsEncrypt | Restart apache
  ansible.builtin.systemd:
    name: 'apache2.service'
    state: restarted
